<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ladaza Agent ç®¡ç†é¡µ - ä¸Šä¼ äº§å“CSV</title>
<style>
  body{font-family:system-ui,Segoe UI,Arial;padding:24px;max-width:760px;margin:auto;background:#fafafa;color:#222}
  h1{margin:0 0 16px}
  .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:16px;box-shadow:0 4px 12px rgba(0,0,0,.04)}
  input[type=file]{margin:12px 0}
  button{background:#b58b6b;color:#fff;border:none;border-radius:10px;padding:10px 16px;cursor:pointer}
  pre{white-space:pre-wrap;background:#0b1020;color:#d6e2ff;padding:12px;border-radius:8px;overflow:auto;max-height:220px}
  a{color:#0b5ed7;text-decoration:none}
</style>
</head>
<body>
  <h1>ğŸ§  Ladaza Agent ç®¡ç†é¡µï¼ˆé›¶ä»£ç å¯¼å…¥CSVï¼‰</h1>
  <div class="card">
    <p>æ­¥éª¤ï¼šé€‰æ‹©ä½ çš„ <b>CSV</b> æ–‡ä»¶ â†’ ç‚¹å‡» <b>å¼€å§‹ä¸Šä¼ </b>ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è§£æå¹¶å†™å…¥çŸ¥è¯†åº“ã€‚</p>
    <p>CSV éœ€è¦åŒ…å«è¡¨å¤´ï¼š<code>åç§°, å°ºå¯¸, æè´¨, ç‰¹ç‚¹, å¤‡æ³¨</code></p>
    <input id="file" type="file" accept=".csv" />
    <br/>
    <button id="go">å¼€å§‹ä¸Šä¼ </button>
    <p id="status"></p>
    <pre id="log"></pre>
    <p>è¿”å›èŠå¤©ï¼š<a href="/">é¦–é¡µ</a></p>
  </div>
<script>
const log = (t)=>{const el=document.getElementById('log'); el.textContent += t + "\n";};
document.getElementById('go').onclick = async ()=>{
  const f = document.getElementById('file').files[0];
  if(!f){ alert('è¯·é€‰æ‹©ä¸€ä¸ªCSVæ–‡ä»¶'); return; }
  document.getElementById('status').textContent = 'â³ è§£æä¸­â€¦';
  const text = await f.text();
  // ç®€å• CSV è§£æï¼ˆå…¼å®¹é€—å·åˆ†éš”ï¼‰
  const rows = text.split(/\r?\n/).filter(x=>x.trim().length);
  const header = rows.shift().split(',');
  const idx = (k)=> header.findIndex(h=>h.trim()===k);
  const iName=idx('åç§°'), iSize=idx('å°ºå¯¸'), iMat=idx('æè´¨'), iFeat=idx('ç‰¹ç‚¹'), iNote=idx('å¤‡æ³¨');
  if([iName,iSize,iMat,iFeat,iNote].some(i=>i<0)){
    document.getElementById('status').textContent = 'âŒ CSV è¡¨å¤´ä¸æ­£ç¡®';
    return;
  }
  const items=[];
  for(const r of rows){
    const cols = r.split(',');
    const t = `${cols[iName] || ''} | å°ºå¯¸:${cols[iSize]||''} | æè´¨:${cols[iMat]||''} | ç‰¹ç‚¹:${cols[iFeat]||''} | å¤‡æ³¨:${cols[iNote]||''}`.trim();
    if(t && t!=='| å°ºå¯¸: | æè´¨: | ç‰¹ç‚¹: | å¤‡æ³¨:') items.push(t);
  }
  log(`ğŸ“¦ å³å°†ä¸Šä¼  ${items.length} æ¡`);
  document.getElementById('status').textContent = 'ğŸš€ ä¸Šä¼ ä¸­â€¦';
  try{
    const res = await fetch('/ingest',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({items})});
    const data = await res.json();
    document.getElementById('status').textContent = 'âœ… å®Œæˆ';
    log(JSON.stringify(data,null,2));
  }catch(e){
    document.getElementById('status').textContent = 'âŒ å¤±è´¥';
    log(String(e));
  }
};
</script>
</body>
</html>
